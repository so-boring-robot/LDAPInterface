{% extends "base.html" %}

{% block content %}
    <!-- Sidebar -->
    <aside class="sidebar" role="complementary" aria-label="Navigation annuaire">
      <div class="side-section">
        <div class="side-title">Unit√©s d‚Äôorganisation</div>
        <nav class="tree" aria-label="Arborescence OU">
          <details open>
            <summary>dc=example,dc=com</summary>
            <a href="#" class="active" data-ou="">Tous les utilisateurs</a>
            <details>
              <summary>ou=People</summary>
              <a href="#" data-ou="ou=People,dc=example,dc=com">People</a>
            </details>
            <details>
              <summary>ou=Groups</summary>
              <a href="#" data-ou="ou=Groups,dc=example,dc=com">Groups</a>
            </details>
            <details>
              <summary>ou=IT</summary>
              <a href="#" data-ou="ou=IT,dc=example,dc=com">IT</a>
            </details>
          </details>
        </nav>
      </div>
      <div class="side-section">
        <div class="side-title">Filtres rapides</div>
        <div class="tree">
          <a href="#" data-filter="active">Actifs</a>
          <a href="#" data-filter="inactive">Inactifs</a>
          <a href="#" data-filter="locked">Verrouill√©s</a>
          <a href="#" data-filter="new">Ajout√©s 30 derniers jours</a>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main" role="main">
      <div class="toolbar" aria-label="Barre d‚Äôactions">
        <label class="select">
          <span>Afficher</span>
          <select id="statusFilter">
            <option value="all">Tous</option>
            <option value="active">Actifs</option>
            <option value="inactive">Inactifs</option>
          </select>
        </label>
        <label class="select">
          <span>OU</span>
          <select id="ouFilter">
            <option value="">Toutes OU</option>
            <option value="ou=People,dc=example,dc=com">ou=People</option>
            <option value="ou=Groups,dc=example,dc=com">ou=Groups</option>
            <option value="ou=IT,dc=example,dc=com">ou=IT</option>
          </select>
        </label>
        <label class="select">
          <span>Tri</span>
          <select id="sortBy">
            <option value="sn">Nom</option>
            <option value="givenName">Pr√©nom</option>
            <option value="uid">UID</option>
            <option value="whenCreated">Date d‚Äôajout</option>
            <option value="active">Statut</option>
          </select>
        </label>
        <label class="select">
          <span>Par</span>
          <select id="sortDir">
            <option value="asc">Croissant</option>
            <option value="desc">D√©croissant</option>
          </select>
        </label>
        <div class="grow"></div>
        <button id="bulkDisable" class="btn">‚õî D√©sactiver</button>
        <button id="bulkEnable" class="btn success">‚úÖ Activer</button>
        <button id="bulkDelete" class="btn warn">üóëÔ∏è Supprimer</button>
      </div>

      <section class="card" aria-label="Liste des utilisateurs">
        <div class="card-header">
          <div class="card-title">Utilisateurs</div>
          <div class="muted"><span id="count">0</span> r√©sultats</div>
        </div>
        <div class="table-wrap">
          <table id="usersTable" aria-describedby="count">
            <thead>
              <tr>
                <th style="width:40px;"><input type="checkbox" id="checkAll" aria-label="Tout s√©lectionner"></th>
                <th data-key="sn">Nom</th>
                <th data-key="givenName">Pr√©nom</th>
                <th data-key="uid">UID</th>
                <th data-key="mail">Email</th>
                <th>R√¥les</th>
                <th data-key="active">Statut</th>
                <th data-key="whenCreated">Date d‚Äôajout</th>
                <th style="width:210px;">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="pagination">
          <div class="muted">Page <span id="pageNo">1</span> / <span id="pageTotal">1</span></div>
          <div class="pager">
            <button class="btn" id="prevPage">‚óÄ</button>
            <button class="btn" id="nextPage">‚ñ∂</button>
            <label class="select">
              <span>Par page</span>
              <select id="pageSize">
                <option>10</option>
                <option>25</option>
                <option>50</option>
                <option>100</option>
              </select>
            </label>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Modal: Ajouter / Modifier -->
  <div class="modal" id="userModal" aria-modal="true" role="dialog" aria-labelledby="userModalTitle">
    <div class="box">
      <div class="hd">
        <div id="userModalTitle">Ajouter un utilisateur</div>
        <button class="icon-btn" data-close="userModal" aria-label="Fermer">‚úñ</button>
      </div>
      <form id="userForm">
        <div class="bd">
          <div class="grid">
            <div class="col-6">
              <div class="field">
                <label class="label">Pr√©nom</label>
                <input class="control" name="givenName" required />
              </div>
            </div>
            <div class="col-6">
              <div class="field">
                <label class="label">Nom</label>
                <input class="control" name="sn" required />
              </div>
            </div>
            <div class="col-4">
              <div class="field">
                <label class="label">UID</label>
                <input class="control" name="uid" required />
              </div>
            </div>
            <div class="col-4">
              <div class="field">
                <label class="label">Email</label>
                <input class="control" type="email" name="mail" required />
              </div>
            </div>
            <div class="col-4">
              <div class="field">
                <label class="label">Mot de passe</label>
                <input class="control" type="password" name="userPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
              </div>
            </div>
            <div class="col-6">
              <div class="field">
                <label class="label">OU</label>
                <select class="control" name="ou">
                  <option value="ou=People,dc=example,dc=com">ou=People</option>
                  <option value="ou=IT,dc=example,dc=com">ou=IT</option>
                  <option value="ou=Groups,dc=example,dc=com">ou=Groups</option>
                </select>
              </div>
            </div>
            <div class="col-6">
              <div class="field">
                <label class="label">R√¥les (s√©par√©s par des virgules)</label>
                <input class="control" name="roles" placeholder="admin, editor" />
              </div>
            </div>
            <div class="col-12">
              <label class="select">
                <span>Statut</span>
                <select name="active" id="activeSelect">
                  <option value="true">Actif</option>
                  <option value="false">Inactif</option>
                </select>
              </label>
            </div>
            <div class="col-12">
              <div class="field">
                <label class="label">Commentaires</label>
                <textarea class="control" name="description" placeholder="Notes, contexte‚Ä¶"></textarea>
              </div>
                        </div>
          </div>
        </div>
        <div class="ft">
          <button type="button" class="btn ghost" data-close="userModal">Annuler</button>
          <button type="submit" class="btn primary">üíæ Enregistrer</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Import CSV -->
  <div class="modal" id="importModal" aria-modal="true" role="dialog" aria-labelledby="importModalTitle">
    <div class="box">
      <div class="hd">
        <div id="importModalTitle">Importer des utilisateurs (CSV)</div>
        <button class="icon-btn" data-close="importModal" aria-label="Fermer">‚úñ</button>
      </div>
      <form id="importForm">
        <div class="bd">
          <div class="dropzone" id="dropzone">
            Glissez-d√©posez votre fichier CSV ici ou cliquez pour s√©lectionner.
            <br><small>Colonnes attendues : pr√©nom, nom, uid, email, mot de passe, OU, r√¥les, actif</small>
            <input type="file" id="csvFile" accept=".csv" hidden>
          </div>
        </div>
        <div class="ft">
          <button type="button" class="btn ghost" data-close="importModal">Annuler</button>
          <button type="submit" class="btn primary">üì• Importer</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Zone de notifications -->
  <div class="toasts" id="toasts"></div>

  <script>
    // --- Donn√©es fictives pour la d√©mo ---
    const users = [
      { sn: "Dupont", givenName: "Jean", uid: "jdupont", mail: "jean.dupont@example.com", roles: ["admin"], active: true, whenCreated: "2025-08-01" },
      { sn: "Martin", givenName: "Sophie", uid: "smartin", mail: "sophie.martin@example.com", roles: ["user"], active: false, whenCreated: "2025-07-15" }
    ];

    const tbody = document.querySelector("#usersTable tbody");
    const countEl = document.getElementById("count");

    function renderUsers() {
      tbody.innerHTML = "";
      users.forEach((u, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><input type="checkbox" data-index="${i}"></td>
          <td>${u.sn}</td>
          <td>${u.givenName}</td>
          <td>${u.uid}</td>
          <td>${u.mail}</td>
          <td>${u.roles.map(r => `<span class="badge role">${r}</span>`).join(" ")}</td>
          <td>${u.active ? '<span class="badge success">Actif</span>' : '<span class="badge danger">Inactif</span>'}</td>
          <td>${u.whenCreated}</td>
          <td class="row-actions">
            <button class="icon-btn" title="Modifier">‚úèÔ∏è</button>
            <button class="icon-btn" title="${u.active ? 'D√©sactiver' : 'Activer'}">${u.active ? '‚õî' : '‚úÖ'}</button>
            <button class="icon-btn" title="Supprimer">üóëÔ∏è</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      countEl.textContent = users.length;
    }
    renderUsers();

    // --- Gestion des modales ---
    document.getElementById("openAdd").onclick = () => openModal("userModal");
    document.getElementById("openImport").onclick = () => openModal("importModal");
    document.querySelectorAll("[data-close]").forEach(btn => {
      btn.onclick = () => closeModal(btn.dataset.close);
    });

    function openModal(id) {
      document.getElementById(id).classList.add("show");
    }
    function closeModal(id) {
      document.getElementById(id).classList.remove("show");
    }

    // --- Import CSV (d√©mo) ---
    const dropzone = document.getElementById("dropzone");
    dropzone.addEventListener("click", () => document.getElementById("csvFile").click());
    dropzone.addEventListener("dragover", e => {
      e.preventDefault();
      dropzone.classList.add("dragover");
    });
    dropzone.addEventListener("dragleave", () => dropzone.classList.remove("dragover"));
    dropzone.addEventListener("drop", e => {
      e.preventDefault();
      dropzone.classList.remove("dragover");
      const file = e.dataTransfer.files[0];
      if (file) showToast(`Fichier "${file.name}" pr√™t √† √™tre import√©`, "success");
    });

    // --- Notifications ---
    function showToast(msg, type="success") {
      const toast = document.createElement("div");
      toast.className = `toast ${type}`;
      toast.textContent = msg;
      document.getElementById("toasts").appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
    }
  </script>
{% endblock %}